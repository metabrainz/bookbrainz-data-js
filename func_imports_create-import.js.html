<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>func/imports/create-import.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#autoCreateNewEditionGroup">autoCreateNewEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#castDiscardVote">castDiscardVote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createEditionGroupForNewEdition">createEditionGroupForNewEdition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createImportDataRecord">createImportDataRecord</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#deleteOauthToken">deleteOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#formatDate">formatDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAddedItems">getAddedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAdditionalEntityProps">getAdditionalEntityProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEditionGroupsCreditedToAuthor">getEditionGroupsCreditedToAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEditionsCreditedToAuthor">getEditionsCreditedToAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntity">getEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModelByType">getEntityModelByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModels">getEntityModels</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityParentAlias">getEntityParentAlias</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOauthToken">getOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRecentImportUtilData">getRecentImportUtilData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRemovedItems">getRemovedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getUnchangedItems">getUnchangedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isNullDate">isNullDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ISODateStringToObject">ISODateStringToObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadAuthorNames">loadAuthorNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseDate">parseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#promiseProps">promiseProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#recursivelyGetAreaParentsWithNames">recursivelyGetAreaParentsWithNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#recursivelyGetRedirectBBID">recursivelyGetRedirectBBID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveOauthToken">saveOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAnnotation">updateAnnotation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateDisambiguation">updateDisambiguation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateOauthToken">updateOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateRelationshipSets">updateRelationshipSets</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">func/imports/create-import.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createImport = createImport;
var _get2 = _interopRequireDefault(require("lodash/get"));
var _snakeCase2 = _interopRequireDefault(require("lodash/snakeCase"));
var _omit2 = _interopRequireDefault(require("lodash/omit"));
var _entity = require("../../types/entity");
var _util = require("../../util");
var _entity2 = require("../entity");
var _misc = require("./misc");
var _alias = require("../alias");
var _annotation = require("../annotation");
var _disambiguation = require("../disambiguation");
var _identifier = require("../identifier");
var _language = require("../language");
var _releaseEvent = require("../releaseEvent");
function _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { default: obj }; }
/*
 * Copyright (C) 2018  Shivam Tripathi
 *               2023  David Kellner
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

function createEntityRecord(transacting, data) {
  return transacting.insert((0, _util.camelToSnake)(data)).into('bookbrainz.entity').returning('bbid');
}
function createOrUpdateImportMetadata(transacting, record) {
  return transacting.insert((0, _util.camelToSnake)(record)).into('bookbrainz.import_metadata').onConflict(['external_source_id', 'external_identifier']).merge();
}
function getImportMetadata(transacting, externalSourceId, externalIdentifier) {
  return transacting.select('pending_entity_bbid', 'accepted_entity_bbid').from('bookbrainz.import_metadata').where((0, _util.camelToSnake)({
    externalIdentifier,
    externalSourceId
  }));
}

/** IDs of extra data sets which not all entity types have. */

/** IDs of all data sets which an entity can have. */

function createImportDataRecord(transacting, dataSets, importData) {
  const {
    entityType
  } = importData;

  /* We omit all extra props which are not taken in as args when creating an
  entity_data record, else it will raise error (of there being no such
  column in the table).
  Entity data props use split versions of dates into (day, month and year)
  	and not directly dates, so we omit them.
  */
  const additionalEntityProps = (0, _omit2.default)((0, _entity2.getAdditionalEntityProps)(importData.data, entityType), ['beginDate', 'endDate']);
  const dataRecordProps = {
    ...dataSets,
    ...additionalEntityProps
  };
  return transacting.insert((0, _util.camelToSnake)(dataRecordProps)).into(`bookbrainz.${(0, _snakeCase2.default)(entityType)}_data`).returning('id');
}
function createOrUpdateImportHeader(transacting, record, entityType) {
  const table = `bookbrainz.${(0, _snakeCase2.default)(entityType)}_import_header`;
  return transacting.insert((0, _util.camelToSnake)(record)).into(table).onConflict('bbid').merge();
}
async function updateEntityExtraDataSets(orm, transacting, importData) {
  // Extract all entity data sets' related fields
  const {
    languages,
    releaseEvents
  } = importData;
  const dataSets = {};
  if (languages) {
    const languageSet = await (0, _language.updateLanguageSet)(orm, transacting, null, languages);
    dataSets.languageSetId = languageSet &amp;&amp; languageSet.get('id');
  }
  if (releaseEvents) {
    const releaseEventSet = await (0, _releaseEvent.updateReleaseEventSet)(orm, transacting, null, releaseEvents);
    dataSets.releaseEventSetId = releaseEventSet &amp;&amp; releaseEventSet.get('id');
  }
  // Skipping publisher field, as they're not required in imports.

  return dataSets;
}
function createImport(orm, importData, {
  existingImportAction = 'skip'
} = {}) {
  if (!_entity.ENTITY_TYPES.includes(importData.entityType)) {
    throw new Error('Invalid entity type');
  }
  return orm.bookshelf.transaction(async transacting => {
    const {
      entityType
    } = importData;
    const {
      alias,
      annotation,
      identifiers,
      disambiguation,
      externalSource
    } = importData.data;
    const externalSourceId = await (0, _misc.getExternalSourceId)(transacting, externalSource);
    const [existingImport] = await getImportMetadata(transacting, externalSourceId, importData.externalIdentifier);
    if (existingImport) {
      const isPendingImport = !existingImport.accepted_entity_bbid;
      if (existingImportAction === 'skip') {
        return {
          importId: existingImport.pending_entity_bbid,
          status: isPendingImport ? 'skipped pending' : 'skipped accepted'
        };
      } else if (isPendingImport) {
        // TODO: update/reuse already existing data of pending imports
      } else {
        // The previously imported entity has already been accepted
        if (existingImportAction === 'update pending') {
          // We only want to update pending, but not accepted entities
          return {
            importId: existingImport.pending_entity_bbid,
            status: 'skipped accepted'
          };
        }
        // We also want to create updates for already accepted entities ('update pending and accepted')
        // TODO: implement this feature in a later version and drop the following temporary return statement
        return {
          importId: existingImport.pending_entity_bbid,
          status: 'skipped accepted'
        };
      }
    }
    const [aliasSet, annotationObj, identifierSet, disambiguationObj, entityExtraDataSets] = await Promise.all([(0, _alias.updateAliasSet)(orm, transacting, null, null, alias), (0, _annotation.updateAnnotation)(orm, transacting, null, annotation, null), (0, _identifier.updateIdentifierSet)(orm, transacting, null, identifiers), (0, _disambiguation.updateDisambiguation)(orm, transacting, null, disambiguation), updateEntityExtraDataSets(orm, transacting, importData.data)]);

    // Create entity type-specific data record
    let dataId = null;
    try {
      const [idObj] = await createImportDataRecord(transacting, {
        aliasSetId: aliasSet &amp;&amp; aliasSet.get('id'),
        annotationId: annotationObj &amp;&amp; annotationObj.get('id'),
        disambiguationId: disambiguationObj &amp;&amp; disambiguationObj.get('id'),
        identifierSetId: identifierSet &amp;&amp; identifierSet.get('id'),
        ...entityExtraDataSets
      }, importData);
      dataId = (0, _get2.default)(idObj, 'id');
    } catch (err) {
      throw new Error(`Error during dataId creation ${err}`);
    }

    // Create import entity (if it is not already existing from a previous import attempt)
    let importId = existingImport?.pending_entity_bbid;
    if (!importId) {
      try {
        const [idObj] = await createEntityRecord(transacting, {
          isImport: true,
          type: entityType
        });
        importId = (0, _get2.default)(idObj, 'bbid');
      } catch (err) {
        throw new Error(`Failed to create a new import ID: ${err}`);
      }
    }
    const importMetadata = {
      additionalData: importData.data.metadata,
      externalIdentifier: importData.externalIdentifier,
      externalSourceId,
      lastEdited: importData.lastEdited,
      pendingEntityBbid: importId
    };
    try {
      await createOrUpdateImportMetadata(transacting, importMetadata);
    } catch (err) {
      throw new Error(`Failed to upsert import metadata: ${err}`);
    }
    try {
      await createOrUpdateImportHeader(transacting, {
        bbid: importId,
        dataId
      }, entityType);
    } catch (err) {
      throw new Error(`Failed to upsert import header: ${err}`);
    }
    return {
      importId,
      status: existingImport ? 'updated pending' : 'created pending'
    };
  });
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Feb 28 2025 17:05:02 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
