<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>func/imports/recent-imports.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#autoCreateNewEditionGroup">autoCreateNewEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#castDiscardVote">castDiscardVote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createEditionGroupForNewEdition">createEditionGroupForNewEdition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createNote">createNote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#deleteOauthToken">deleteOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#entityTypes">entityTypes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#formatDate">formatDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAddedItems">getAddedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getComparisonFunc">getComparisonFunc</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEditionGroupsCreditedToAuthor">getEditionGroupsCreditedToAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEditionsCreditedToAuthor">getEditionsCreditedToAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntity">getEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModelByType">getEntityModelByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModels">getEntityModels</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityParentAlias">getEntityParentAlias</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntitySetMetadataByType">getEntitySetMetadataByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOauthToken">getOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRecentImportUtilData">getRecentImportUtilData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRemovedItems">getRemovedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getUnchangedItems">getUnchangedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#incrementEditorEditCountById">incrementEditorEditCountById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadAuthorNames">loadAuthorNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseDate">parseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#promiseProps">promiseProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#recursivelyGetAreaParentsWithNames">recursivelyGetAreaParentsWithNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#recursivelyGetRedirectBBID">recursivelyGetRedirectBBID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveOauthToken">saveOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAnnotation">updateAnnotation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateDisambiguation">updateDisambiguation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateOauthToken">updateOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateRelationshipSets">updateRelationshipSets</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">func/imports/recent-imports.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getRecentImports = getRecentImports;
exports.getTotalImports = getTotalImports;

var _get2 = _interopRequireDefault(require("lodash/get"));

var _map2 = _interopRequireDefault(require("lodash/map"));

var _flatten2 = _interopRequireDefault(require("lodash/flatten"));

var _snakeCase2 = _interopRequireDefault(require("lodash/snakeCase"));

var _assign2 = _interopRequireDefault(require("lodash/assign"));

var _values2 = _interopRequireDefault(require("lodash/values"));

var _entity = require("../entity");

var _alias = require("../alias");

var _moment = _interopRequireDefault(require("moment"));

var _misc = require("./misc");

var _util = require("../../util");

function _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { default: obj }; }

/** getRecentImportIdsByType -
 * @param  {Transaction} transacting - Transaction object
 * @param  {number} limit - To limit the number of importIds fetched
 * @param  {number} offset - We offset the result by this value
 * @returns {Promise&lt;Object&lt;Array>>} - Returns an object containing arrays of
 * 		importIds of various importTypes
 */
async function getRecentImportUtilData(transacting, limit, offset) {
  // Extract recent imports, types and import timeStamp
  const recentImportUtilsData = await transacting.select('link.imported_at', 'link.origin_source_id', 'bookbrainz.import.id', 'bookbrainz.import.type').from('bookbrainz.import').join(transacting.select('import_id', 'imported_at', 'origin_source_id').from('bookbrainz.link_import').orderBy('imported_at').whereNot('import_id', null).limit(limit).offset(offset).as('link'), 'link.import_id', 'bookbrainz.import.id');
  /* Contruct importHolder object (holds importIds classified by their types)
  	object of form {type: []} */

  const importHolder = (0, _values2.default)(_entity.entityTypes).reduce((holder, type) => (0, _assign2.default)(holder, {
    [type]: []
  }), {});
  /* Returns the holder object which has two fields:
  	=> importHolder: Object{type: Array[importIds]}
  		Where type is entityType. This essentially classifies all the
  		imports into the their respective types
  	=> timestampMap: Object{importId: imported_at}
  		This holds a mapping of all imports and their imported_at timestamps
  	=> originIdMap: Object{originId: origin_id}
  		This holds a mapping of all imports and their origin_ids
  	*/

  return recentImportUtilsData.reduce((holder, data) => {
    holder.importHolder[data.type].push(data.id);
    holder.originIdMap[data.id] = data.origin_source_id;
    holder.timeStampMap[data.id] = data.imported_at;
    return holder;
  }, {
    importHolder,
    originIdMap: {},
    timeStampMap: {}
  });
}

function getRecentImportsByType(transacting, type, importIds) {
  return transacting.select('*').from(`bookbrainz.${(0, _snakeCase2.default)(type)}_import`).whereIn('import_id', importIds);
}

async function getRecentImports(orm, transacting, limit = 10, offset = 0) {
  /* Fetch most recent ImportIds classified by importTypes
  	=> importHolder - holds recentImports classified by entity type
  	=> timeStampMap - holds value importedAt value in object with importId
  		as key
  	=> originIdMap - holds value originId value in object with importId as
  		key
  */
  const {
    importHolder: recentImportIdsByType,
    timeStampMap,
    originIdMap
  } = await getRecentImportUtilData(transacting, limit, offset);
  /* Qs. What are all import types? Ans => Extract the values from entityTypes
  	[Author, Edition, EditionGroup, Publisher, Work] */

  const importTypes = (0, _values2.default)(_entity.entityTypes);
  /* Fetch imports for each importType using their importIds
  	We first pass type and id to fetch function, await all those promises
  	and then flatten the array containing those results. Classification by
  	type is important as only by knowing types we can access dataId and
  	hence subsequent data.
  */

  const recentImports = (0, _flatten2.default)(await Promise.all(importTypes.map(type => getRecentImportsByType(transacting, type, recentImportIdsByType[type])))); // Fetch all default alias ids

  const defaultAliasIds = (0, _map2.default)(recentImports, 'default_alias_id'); // Fetch default aliases using the default alias ids

  const defaultAliasesMap = await (0, _alias.getAliasByIds)(transacting, defaultAliasIds);
  /* Add timestamp, source and defaultAlias to the recentImports
  	Previously while getting utils data we fetched a mapping of importId to
  	timestamp and oringId.
  	We also fetched map of aliasId to alias object.
  	Now using those we populate our final object */
  // First, get the origin mapping => {originId: name}

  const sourceMapping = await (0, _misc.originSourceMapping)(transacting, true);
  return recentImports.map(recentImport => {
    // Add timestamp
    recentImport.importedAt = (0, _moment.default)(timeStampMap[recentImport.import_id]).format('YYYY-MM-DD'); // Add origin source

    const originId = originIdMap[recentImport.import_id];
    recentImport.source = sourceMapping[originId]; // Add default alias

    const defaultAliasId = (0, _get2.default)(recentImport, 'default_alias_id');
    recentImport.defaultAlias = defaultAliasesMap[defaultAliasId];
    return (0, _util.snakeToCamel)(recentImport);
  });
}

async function getTotalImports(transacting) {
  const [{
    count
  }] = await transacting('bookbrainz.link_import').count('import_id');
  return parseInt(count, 10);
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Tue Sep 06 2022 16:20:37 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
